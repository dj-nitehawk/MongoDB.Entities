<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>Migration system | MongoDB.Entities </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="Migration system | MongoDB.Entities ">
      <meta name="description" content="A data access library for MongoDB with an elegant api, LINQ support and built-in entity relationship management.">
      
      <link rel="icon" href="../images/favicon.ico">
      <link rel="stylesheet" href="../public/docfx.min.css">
      <link rel="stylesheet" href="../public/main.css">
      <meta name="docfx:navrel" content="../toc.html">
      <meta name="docfx:tocrel" content="toc.html">
      
      <meta name="docfx:rel" content="../">
      
      
      
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../public/docfx.min.js"></script>

      <script>
        const theme = localStorage.getItem('theme') || 'auto'
        document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
      </script>

  </head>

  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../index.html">
            <img id="logo" class="svg" src="../images/icon.png" alt="">
            
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="migration-system">Migration system</h1>

<p>there's a simple data migration system similar to that of EntityFramework where you can write migration classes with logic for transforming the database and content in order to bring it up-to-date with the current shape of your c# entity schema.</p>
<h3 id="migration-classes">Migration classes</h3>
<p>create migration classes that has names starting with <code>_number_</code> followed by anything you'd like and implement the interface <code>IMigration</code>.</p>
<p>here are a couple of valid migration class definitions:</p>
<pre><code class="lang-csharp">public class _001_i_will_be_run_first : IMigration { }
public class _002_i_will_be_run_second : IMigration { }
public class _003_i_will_be_run_third : IMigration { }
</code></pre>
<p>next implement the <code>UpgradeAsync()</code> method of IMigration and place your migration logic there.</p>
<h3 id="run-migrations">Run Migrations</h3>
<p>in order to execute the migrations, simply call <code>db.MigrateAsync()</code> whenever you need the database brought up to date. the library keeps track of the last migration run and will execute all newer migrations in the order of their number. in most cases, you'd place the following line of code in the startup of your app right after initializing the database.</p>
<pre><code class="lang-csharp">await db.MigrateAsync();
</code></pre>
<p>the above will try to discover all migrations from all assemblies of the application if it's a multi-project solution. you can speed things up a bit by specifying a type so that migrations will only be discovered from the same assembly/project as the specified type, like so:</p>
<pre><code class="lang-csharp">await db.MigrateAsync&lt;SomeType&gt;();
</code></pre>
<p>it's also possible to have more control by supplying a collection of migration class instances, which comes in handy if your migrations require other dependencies.</p>
<pre><code class="lang-csharp">await db.MigrationsAsync(new IMigration[]
{
    new _001_seed_data(someDependency),
    new _002_transform_data(someDependency)
});
</code></pre>
<h3 id="examples">Examples</h3>
<h4 id="merge-two-properties">Merge two properties</h4>
<p>let's take the scenario of having the first and last names of an Author entity stored in two separate properties and later on deciding to merge them into a single property called &quot;FullName&quot;.</p>
<pre><code class="lang-csharp">public class _001_merge_first_and_last_name_to_fullname_field : IMigration
{
    private class Author : Entity
    {
        public string Name { get; set; }
        public string Surname { get; set; }
        public string FullName { get; set; }
    }

    public async Task UpgradeAsync()
    {
        await db.Fluent&lt;Author&gt;()
                .Project(a =&gt; new { id = a.ID, fullname = a.Name + &quot; &quot; + a.Surname })
                .ForEachAsync(async a =&gt;
                {
                    await db.Update&lt;Author&gt;()
                            .Match(_ =&gt; true)
                            .Modify(x =&gt; x.FullName, a.fullname)
                            .ExecuteAsync();
                });
    }
}
</code></pre>
<p>if your collection has many thousands of documents, the above code will be less efficient. below is another more efficient way to achieve the same result using a single mongodb command if your server version is v4.2 or newer.</p>
<pre><code class="lang-csharp">public class _001_merge_first_and_last_name_to_fullname_field : IMigration
{
    public Task UpgradeAsync()
    {
      return db.Update&lt;Author&gt;()
               .Match(_ =&gt; true)
               .WithPipelineStage(&quot;{$set:{FullName:{$concat:['$Name',' ','$Surname']}}}&quot;)
               .ExecutePipelineAsync();
    }
}
</code></pre>
<h4 id="rename-a-property">Rename a property</h4>
<pre><code class="lang-csharp">public class _002_rename_fullname_to_authorname : IMigration
{
    public Task UpgradeAsync()
    {
      return db.Update&lt;Author&gt;()
                .Match(_ =&gt; true)
                .Modify(b =&gt; b.Rename(&quot;FullName&quot;, &quot;AuthorName&quot;))
                .ExecuteAsync();
    }
}
</code></pre>
<h4 id="rename-a-collection">Rename a collection</h4>
<pre><code class="lang-csharp">public class _003_rename_author_collection_to_writer : IMigration
{
    public Task UpgradeAsync()
    {
      return db.Database()
               .RenameCollectionAsync(&quot;Author&quot;, &quot;Writer&quot;);
    }
}
</code></pre>

</article>

        <div class="contribution d-print-none">
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          Developed by <a href='https://github.com/dj-nitehawk'>Đĵ ΝιΓΞΗΛψΚ</a> and <a href='https://github.com/dj-nitehawk/MongoDB.Entities/graphs/contributors'>contributors</a> / Licensed under <a href='https://github.com/dj-nitehawk/MongoDB.Entities/blob/master/LICENSE'>MIT</a> / Website generated by <a href='https://dotnet.github.io/docfx/'>DocFX</a>
        </div>
      </div>
    </footer>
  </body>
</html>
