<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>ACID compliant transactions | MongoDB.Entities </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="ACID compliant transactions | MongoDB.Entities ">
      <meta name="description" content="A data access library for MongoDB with an elegant api, LINQ support and built-in entity relationship management.">
      
      <link rel="icon" href="../images/favicon.ico">
      <link rel="stylesheet" href="../public/docfx.min.css">
      <link rel="stylesheet" href="../public/main.css">
      <meta name="docfx:navrel" content="../toc.html">
      <meta name="docfx:tocrel" content="toc.html">
      
      <meta name="docfx:rel" content="../">
      
      
      
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../public/docfx.min.js"></script>

      <script>
        const theme = localStorage.getItem('theme') || 'auto'
        document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
      </script>

  </head>

  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../index.html">
            <img id="logo" class="svg" src="../images/icon.png" alt="">
            
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="acid-compliant-transactions">ACID compliant transactions</h1>

<p>multi-document transactions are performed like the following:</p>
<pre><code class="lang-csharp">var book1 = new Book { Title = &quot;book one&quot; };
var book2 = new Book { Title = &quot;book two&quot; };

await db.SaveAsync(new[] { book1, book2 });

using (var t = db.Transaction())
{
    var author1 = new Author { Name = &quot;one&quot; };
    var author2 = new Author { Name = &quot;two&quot; };

    await t.SaveAsync(new[] { author1, author2 });

    await t.DeleteAsync&lt;Book&gt;(new[] { book1.ID, book2.ID });

    await t.CommitAsync();
}
</code></pre>
<p>in the above code, book1 and book2 are saved before the transaction begins. author1 and author2 are created within the transaction and book1 and book2 are deleted within the transaction.</p>
<p>a transaction is started when you instantiate a <code>Transaction</code> object via <code>db.Transaction()</code>. you then perform all transaction logic using the methods supplied by that class such as <code>.SaveAsync()</code>, <code>.DeleteAsync()</code>, <code>.Update()</code>, <code>.Find()</code> instead of the <code>db</code> instance that created the transaction.</p>
<p>whatever transactional operations you do are only saved to the database once you call the <code>.CommitAsync()</code> method. if you do not call .CommitAsync(), then nothing changes in the database.</p>
<p>if an exception occurs before the .CommitAsync() line is reached, all changes are rolled back and the transaction is implicitly terminated.</p>
<p>it is best to always wrap the transaction in a <code>using statement</code> because reaching the end of the using statement will automatically end the transaction and dispose the underlying session. if no using statement is used, you will have to manually dispose the transaction object you created in order to finalize things.</p>
<p>you can also call <code>.AbortAsync()</code> to abort a transaction prematurely if needed at which point all changes will be rolled back.</p>
<h2 id="relationship-manipulation">Relationship Manipulation</h2>
<p><a href="Relationships-Referenced.html">relationships</a> within a transaction requires passing down the session to the <code>.Add()</code> and <code>.Remove()</code> methods as shown below.</p>
<pre><code class="lang-csharp">using (var t = db.Transaction())
{
    var author = new Author { Name = &quot;author one&quot; };
    await t.SaveAsync(author);

    var book = new Book { Title = &quot;book one&quot; };
    await t.SaveAsync(book);

    await author.Books.AddAsync(book, t.Session);
    await author.Books.RemoveAsync(book, t.Session);

    await t.CommitAsync();
}
</code></pre>
<h2 id="file-storage">File Storage</h2>
<p><a href="File-Storage.html">file storage</a> within a transaction also requires passing down the session like so:</p>
<pre><code class="lang-csharp">using (var t = db.Transaction())
{
    var picture = new Picture { Title = &quot;my picture&quot; };
    await t.SaveAsync(picture);

    var streamTask = new HttpClient()
        .GetStreamAsync(&quot;https://placekitten.com/g/4000/4000&quot;);

    using (var stream = await streamTask)
    {
        await picture.Data(db).UploadAsync(stream, session: t.Session);
    }

    await t.CommitAsync();
}
</code></pre>

</article>

        <div class="contribution d-print-none">
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          Developed by <a href='https://github.com/dj-nitehawk'>Đĵ ΝιΓΞΗΛψΚ</a> and <a href='https://github.com/dj-nitehawk/MongoDB.Entities/graphs/contributors'>contributors</a> / Licensed under <a href='https://github.com/dj-nitehawk/MongoDB.Entities/blob/master/LICENSE'>MIT</a> / Website generated by <a href='https://dotnet.github.io/docfx/'>DocFX</a>
        </div>
      </div>
    </footer>
  </body>
</html>
