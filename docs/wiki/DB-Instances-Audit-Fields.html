<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>Automatic audit fields | MongoDB.Entities </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="Automatic audit fields | MongoDB.Entities ">
      <meta name="description" content="A data access library for MongoDB with an elegant api, LINQ support and built-in entity relationship management.">
      
      <link rel="icon" href="../images/favicon.ico">
      <link rel="stylesheet" href="../public/docfx.min.css">
      <link rel="stylesheet" href="../public/main.css">
      <meta name="docfx:navrel" content="../toc.html">
      <meta name="docfx:tocrel" content="toc.html">
      
      <meta name="docfx:rel" content="../">
      
      
      
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../public/docfx.min.js"></script>

      <script>
        const theme = localStorage.getItem('theme') || 'auto'
        document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
      </script>

  </head>

  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../index.html">
            <img id="logo" class="svg" src="../images/icon.png" alt="">
            
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="automatic-audit-fields">Automatic audit fields</h1>

<p>instead of setting the audit values manually on each and every save or update operation, you can take advantage of a <code>DBContext</code> instance where you will instantiate the context by providing it with the details of the current user performing the operations once, and then use the db context to perform all subsequesnt save/update operations so that all the audit fields will be set on the entities automatically.</p>
<h2 id="enable-audit-fields">Enable audit fields</h2>
<p>simply add a property of type <code>ModifiedBy</code> to the entity class where you'd like to enable audit fields. The <code>ModifiedBy</code> type is provided by the library. It can be inherited and other properties can be added to it as you please.</p>
<pre><code class="lang-csharp">public class Book : Entity
{
    public string Title { get; set; }
    public ModifiedBy ModifiedBy { get; set; }
}
</code></pre>
<h2 id="instantiate-a-dbcontext">Instantiate a DBContext</h2>
<p>instantiate a context by providing it a <code>ModifiedBy</code> instance with the current user's details filled in.</p>
<pre><code class="lang-csharp">var currentUser = new ModifiedBy
{
    UserID = &quot;xxxxxxxxxxxx&quot;,
    UserName = &quot;Kip Jennings&quot;
};

var db = new DBContext(modifiedBy: currentUser);
</code></pre>
<h2 id="perform-entity-operations">Perform entity operations</h2>
<p>in order for the auto audit fields to work, you must use the db context to perform the operations instead of the <code>DB</code> instances methods like you'd typically use.</p>
<pre><code class="lang-csharp">var book = new Book { Title = &quot;test book&quot; };

await db.SaveAsync(book);

await db.Update&lt;Book&gt;()
        .MatchID(book.ID)
        .Modify(b =&gt; b.Title, &quot;updated title&quot;)
        .ExecuteAsync();
</code></pre>
<p>doing so will result in the following document in mongodb:</p>
<pre><code>{
	&quot;_id&quot; : ObjectId(&quot;xxxxxxxxxxxx&quot;),
	&quot;Title&quot; : &quot;updated title&quot;, //this will initially be 'test book'
	&quot;ModifiedBy&quot; : {
		&quot;UserID&quot; : &quot;xxxxxxxxxxxx&quot;,
		&quot;UserName&quot; : &quot;Kip Jennings&quot;
	}
}
</code></pre>
<h2 id="getset-audit-values">Get/set audit values</h2>
<p>it is also possible to instantiate a <code>DBContext</code> without supplying a <code>ModifiedBy</code> to the constructor and set or get it like so:</p>
<pre><code class="lang-csharp">var db = new DBContext();

db.ModifiedBy = new ModifiedBy
{
    UserID = &quot;xxxxxxxxxxxx&quot;,
    UserName = &quot;Kip Jennings&quot;
};

var currentUser = db.ModifiedBy;
</code></pre>
<h2 id="transaction-support">Transaction support</h2>
<p>a transaction with audit field support can be performed with the DBContext like so:</p>
<pre><code class="lang-csharp">var db = new DBContext(modifiedBy: currentUser);

using (db.Transaction())
{
    await db.SaveAsync(book);
    await db.CommitAsync();
}
</code></pre>
<p>or it can be performed with a <code>Transaction</code> instance like so:</p>
<pre><code class="lang-csharp">using (var TN = db.Transaction(modifiedBy: currentUser))
{
    await TN.SaveAsync(book);
    await TN.CommitAsync();
}
</code></pre>
<div class="NOTE">
<h5>Note</h5>
<p>please refer to the <a href="Transactions.html">transactions page</a> for a detailed explanation of how transactions work.</p>
</div>

</article>

        <div class="contribution d-print-none">
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          Developed by <a href='https://github.com/dj-nitehawk'>Đĵ ΝιΓΞΗΛψΚ</a> and <a href='https://github.com/dj-nitehawk/MongoDB.Entities/graphs/contributors'>contributors</a> / Licensed under <a href='https://github.com/dj-nitehawk/MongoDB.Entities/blob/master/LICENSE'>MIT</a> / Website generated by <a href='https://dotnet.github.io/docfx/'>DocFX</a>
        </div>
      </div>
    </footer>
  </body>
</html>
